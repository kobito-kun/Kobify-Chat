<html>
  
<head>
  <title>Kobify Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.1/tailwind.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />  
</head>
<body>  
  <div class="min-h-screen bg-gradient-to-br from-blue-200 to-blue-600">
    <div class="p-10 grid grid-cols-1 lg:grid-cols-3" id="bodyone">
    <div class="hidden lg:block">
      <h3 class="text-2xl text-center font-bold text-white">Public Channels</h3>
      <div id="firebaseui-auth-container"></div>
    </div>
    <div>
      <h3 class="text-2xl text-center font-bold text-white">#General | Welcome to General Chat</h3>
      <div id="messagebox" style="overflow-y: scroll; max-height: 440px;">
        
      </div>
      <div class="p-4 m-2 rounded-lg bg-white">
        <input type="text" class="border-b border-black w-full focus:outline-none p-2 shadow" id="message_value">
      </div>
    </div>
    <div class="hidden lg:block">
      <h3 class="text-2xl text-center font-bold text-white">User's Online</h3>
      <div id="usersbox" class="bg-white rounded-lg p-4 m-2">
      
      </div>      
    </div>
    </div>
    <div class="h-full flex justify-center items-center" id="body2">
      <input class="px-4 py-2 border border-black rounded-lg shadow focus:outline-none" placeholder="Input a username" id="initial_username" /><button onclick="submitUsername()" class="font-bold bg-white px-4 py-2 rounded-lg shadow mx-2 transform duration-300 hover:scale-105">Submit</button>
    </div>
  </div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.2/dist/chart.min.js"></script>
<script>
  const socket = io();
  const messages = document.getElementById("messagebox")
  const connection_message = document.getElementById("connection")
  const message_value = document.getElementById("message_value")
  const users_box = document.getElementById("usersbox")
  let user

  const submitUsername = () => {
    const user_value = document.getElementById("initial_username").value
    localStorage.setItem("username", user_value)
    location.reload()
  }

  socket.on('message', r => {
    addMessageToBox(r)
  })

  socket.on('connected_initial_message', data => {
    if(localStorage.getItem("username")){
      user = localStorage.getItem("username")
      document.getElementById("body2").style.display = "none";
      socket.emit("connected_initial_message", user)
    }else{
      document.getElementById("bodyone").style.display = "none";
      user = data.user_id
    }
  })

  socket.on('users_online', data => {
    console.log(data)
    users_box.innerHTML = ""
    data.users.forEach(item => users_box.innerHTML += `<li>${item.username}</li>`)
  })

  socket.on('user_activity', (data) => {
    console.log("User_act", data)
    const variablename = data.joined ? "Just joined the chat." : "Just left the chat"
    const message = {
      "user": data.user.username,
      "message": variablename
    }
    addMessageToBox(message)
  })

  message_value.addEventListener("keyup", (event) => {
    if(event.keyCode == 13){
      event.preventDefault();
      sendMessage()
    }
  })

  const sendMessage = () => {
    socket.emit('message', {
      "action": "add",
      "id": null,
      "user": user,
      "message": message_value.value
    })
    message_value.value = "";
  }

  const addMessageToBox = (data) => {
    messages.innerHTML += `<li class="list-none bg-white rounded-lg shadow p-2 m-2"><span class="font-bold">${data.user}</span><p>${data.message}</p></li`
  }

</script>
</html>